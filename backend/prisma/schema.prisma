generator client {
  provider = "prisma-client-js"
  engineType      = "library"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      String            @id @default(uuid())
  email                   String            @unique
  password                String
  role                    UserRole          @default(USER)
  status                  UserStatus        @default(PENDING_APPROVAL)
  firstName               String
  lastName                String
  phone                   String?
  dateOfBirth             DateTime?
  profileImageUrl         String?
  membershipType          MembershipType    @default(FREE)
  membershipExpiry        DateTime?
  emailVerified           Boolean           @default(false)
  twoFactorEnabled        Boolean           @default(false)
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  lastLoginAt             DateTime?
  emailVerificationExpiry DateTime?
  emailVerificationToken  String?
  twoFactorSecret         String?
  addresses               Address[]
  auditLogs               AuditLog[]
  deliveryRequests        DeliveryRequest[]
  notifications           Notification[]
  payments                Payment[]
  reservations            Reservation[]
  reviews                 Review[]
  transactions            Transaction[]
  borrowRequests          BorrowRequest[]   @relation("UserBorrowRequests")
  approvedRequests        BorrowRequest[]   @relation("ApprovedRequests")
  rejectedRequests        BorrowRequest[]   @relation("RejectedRequests")

  @@index([email])
  @@index([role])
  @@index([status])
}

model Address {
  id               String            @id @default(uuid())
  userId           String
  addressType      String
  addressLine1     String
  addressLine2     String?
  city             String
  state            String
  pincode          String
  landmark         String?
  latitude         Float?
  longitude        Float?
  isDefault        Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveryRequests DeliveryRequest[]

  @@index([userId])
}

model Book {
  id                 String            @id @default(uuid())
  isbn               String            @unique
  title              String
  author             String
  publisher          String?
  edition            String?
  publicationYear    Int?
  language           String            @default("English")
  genre              String
  category           String
  subCategory        String?
  pages              Int?
  format             String?
  description        String?
  coverImageUrl      String?
  totalCopies        Int               @default(1)
  availableCopies    Int               @default(1)
  bookValue          Float
  securityDeposit    Float             @default(200)
  loanPeriodDays     Int               @default(14)
  finePerDay         Float             @default(5)
  maxRenewals        Int               @default(2)
  isDeliveryEligible Boolean           @default(true)
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  copies             BookCopy[]
  deliveryRequests   DeliveryRequest[]
  reservations       Reservation[]
  reviews            Review[]
  transactions       Transaction[]
  borrowRequests     BorrowRequest[]

  @@index([isbn])
  @@index([title])
  @@index([author])
  @@index([genre])
  @@index([category])
}

model BookCopy {
  id              String          @id @default(uuid())
  bookId          String
  copyNumber      String
  barcode         String          @unique
  status          BookStatus      @default(AVAILABLE)
  condition       BookCondition   @default(GOOD)
  shelfLocation   String?
  section         String?
  acquiredDate    DateTime        @default(now())
  lastIssuedDate  DateTime?
  conditionNotes  String?
  conditionPhotos Json?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  book            Book            @relation(fields: [bookId], references: [id], onDelete: Cascade)
  transactions    Transaction[]
  borrowRequests  BorrowRequest[]

  @@index([bookId])
  @@index([barcode])
  @@index([status])
}

model Transaction {
  id              String            @id @default(uuid())
  userId          String
  bookId          String
  bookCopyId      String
  librarianId     String?
  issueDate       DateTime          @default(now())
  dueDate         DateTime
  returnDate      DateTime?
  status          TransactionStatus @default(ISSUED)
  renewalCount    Int               @default(0)
  fineAmount      Float             @default(0)
  finePaid        Boolean           @default(false)
  damageCharge    Float             @default(0)
  issueCondition  Json?
  returnCondition Json?
  isHomeDelivery  Boolean           @default(false)
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  payments        Payment[]
  bookCopy        BookCopy          @relation(fields: [bookCopyId], references: [id])
  book            Book              @relation(fields: [bookId], references: [id])
  user            User              @relation(fields: [userId], references: [id])
  borrowRequest   BorrowRequest?

  @@index([userId])
  @@index([bookId])
  @@index([status])
  @@index([dueDate])
}

model BorrowRequest {
  id          String              @id @default(uuid())
  userId      String
  bookId      String
  requestDate DateTime            @default(now())
  status      BorrowRequestStatus @default(PENDING)
  notes       String?

  // Approval fields
  approvedBy String?
  approvedAt DateTime?
  bookCopyId String?
  dueDate    DateTime?

  // Rejection fields
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?

  // Fulfillment
  transactionId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User         @relation("UserBorrowRequests", fields: [userId], references: [id], onDelete: Cascade)
  book        Book         @relation(fields: [bookId], references: [id], onDelete: Cascade)
  bookCopy    BookCopy?    @relation(fields: [bookCopyId], references: [id])
  approver    User?        @relation("ApprovedRequests", fields: [approvedBy], references: [id])
  rejecter    User?        @relation("RejectedRequests", fields: [rejectedBy], references: [id])
  transaction Transaction? @relation(fields: [transactionId], references: [id])

  @@index([userId])
  @@index([bookId])
  @@index([status])
  @@index([requestDate])
}

model Reservation {
  id           String    @id @default(uuid())
  userId       String
  bookId       String
  reservedDate DateTime  @default(now())
  expiresAt    DateTime?
  notifiedAt   DateTime?
  status       String
  priority     Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  book         Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bookId])
  @@index([status])
}

model DeliveryRequest {
  id                   String             @id @default(uuid())
  userId               String
  bookId               String
  addressId            String
  requestType          String
  preferredDate        DateTime
  preferredSlot        String
  scheduledDate        DateTime?
  scheduledSlot        String?
  assignedToId         String?
  assignedAt           DateTime?
  status               DeliveryStatus     @default(PENDING)
  deliveredAt          DateTime?
  deliveryProofUrl     String?
  deliverySignatureUrl String?
  deliveryNotes        String?
  conditionOnDelivery  Json?
  conditionOnReturn    Json?
  deliveryFee          Float              @default(50)
  securityDeposit      Float              @default(200)
  specialInstructions  String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  address              Address            @relation(fields: [addressId], references: [id])
  assignedTo           DeliveryPersonnel? @relation(fields: [assignedToId], references: [id])
  book                 Book               @relation(fields: [bookId], references: [id])
  user                 User               @relation(fields: [userId], references: [id])
  payments             Payment[]

  @@index([userId])
  @@index([bookId])
  @@index([status])
  @@index([assignedToId])
}

model DeliveryPersonnel {
  id                   String            @id @default(uuid())
  name                 String
  phone                String
  email                String?
  employeeId           String            @unique
  status               String            @default("active")
  vehicleType          String?
  vehicleNumber        String?
  totalDeliveries      Int               @default(0)
  successfulDeliveries Int               @default(0)
  failedDeliveries     Int               @default(0)
  averageRating        Float?
  available            Boolean           @default(true)
  currentLocationLat   Float?
  currentLocationLng   Float?
  lastLocationUpdate   DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  deliveryRequests     DeliveryRequest[]

  @@index([employeeId])
  @@index([status])
}

model Payment {
  id                String           @id @default(uuid())
  userId            String
  transactionId     String?
  deliveryRequestId String?
  amount            Float
  paymentMethod     PaymentMethod
  paymentStatus     PaymentStatus    @default(PENDING)
  razorpayOrderId   String?
  razorpayPaymentId String?
  razorpaySignature String?
  deliveryFee       Float            @default(0)
  securityDeposit   Float            @default(0)
  lateFee           Float            @default(0)
  damageCharge      Float            @default(0)
  refundAmount      Float?
  refundDate        DateTime?
  refundReason      String?
  paymentDate       DateTime?
  notes             String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  deliveryRequest   DeliveryRequest? @relation(fields: [deliveryRequestId], references: [id])
  transaction       Transaction?     @relation(fields: [transactionId], references: [id])
  user              User             @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([paymentStatus])
  @@index([razorpayOrderId])
}

model Review {
  id           String   @id @default(uuid())
  userId       String
  bookId       String
  rating       Int
  reviewText   String?
  helpfulCount Int      @default(0)
  status       String   @default("pending")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  book         Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@index([bookId])
  @@index([rating])
}

model Notification {
  id        String               @id @default(uuid())
  userId    String
  type      NotificationType
  category  NotificationCategory
  title     String
  message   String
  read      Boolean              @default(false)
  sentAt    DateTime?
  createdAt DateTime             @default(now())
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([category])
}

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  category    String
  description String?
  updatedBy   String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@index([category])
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([action])
  @@index([createdAt])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  LIBRARIAN
  USER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_APPROVAL
}

enum MembershipType {
  FREE
  PREMIUM
  STUDENT
  CORPORATE
}

enum BookStatus {
  AVAILABLE
  ISSUED
  RESERVED
  IN_TRANSIT_DELIVERY
  IN_TRANSIT_RETURN
  DAMAGED
  LOST
  MAINTENANCE
}

enum BookCondition {
  NEW
  EXCELLENT
  GOOD
  FAIR
  POOR
  DAMAGED
}

enum TransactionStatus {
  ISSUED
  RETURNED
  OVERDUE
  RENEWED
  CANCELLED
}

enum BorrowRequestStatus {
  PENDING
  APPROVED
  REJECTED
  FULFILLED
  CANCELLED
}

enum DeliveryStatus {
  PENDING
  PAYMENT_CONFIRMED
  APPROVED
  READY_FOR_DELIVERY
  ASSIGNED
  OUT_FOR_DELIVERY
  DELIVERED
  PICKUP_SCHEDULED
  PICKUP_IN_PROGRESS
  RETURNED
  FAILED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  NET_BANKING
  WALLET
}

enum NotificationType {
  EMAIL
  SMS
  IN_APP
}

enum NotificationCategory {
  BOOK_ISSUED
  BOOK_RETURNED
  DUE_REMINDER
  OVERDUE_NOTICE
  RESERVATION_AVAILABLE
  DELIVERY_UPDATE
  PAYMENT_CONFIRMATION
  FINE_NOTICE
  BORROW_REQUEST_CREATED
  BORROW_REQUEST_APPROVED
  BORROW_REQUEST_REJECTED
}

model Setting {
  id           String          @id @default(uuid())
  key          String          @unique
  value        String // JSON stringified for complex values
  category     SettingCategory
  dataType     SettingDataType
  description  String?
  isEditable   Boolean         @default(true)
  defaultValue String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([category])
  @@index([key])
}

enum SettingCategory {
  LIBRARY
  FINES
  MEMBERSHIP
  LOANS
  SYSTEM
}

enum SettingDataType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}
